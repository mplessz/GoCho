---
title: "explo06-Compare-treated.Rmd"
author: "Marie Plessz"
output:
  html_document:
    df_print: paged
---
# comparer les traités et les controles selectionnées pour l'analyse DiD

* package modelsummary :
(https://vincentarelbundock.github.io/modelsummary/)

* des explications détaillées sur comment calculer les erreurs standard des odds-ratios après un logit... c pas gagné.
(https://stackoverflow.com/questions/16236560/odds-ratios-instead-of-logits-in-stargazer-latex-output)

```{r setup}

library(haven)
library(tidyverse)
library(questionr)
library(gtsummary)
library(glue)
library(MatchIt)
library(modelsummary)
library(gt)
library(stargazer)

options(OutDec= ",",
					encoding = "utf-8")

tag <- "Programme: explo06-Compare-treated.Rmd"
```

# préparation des données -----

```{r}

data_sehar <- read_dta("Data-Sehar/Data/STUDYPOP_INC2017_NEW_V3.dta")
data_comp <- read_dta("Data/Cree/HDR6_01_tous.dta", col_select =
												c("proj_isp", "typmen", "prive", "inde", "aveccouple01",
													"avecenf01", "age_cl", "homme"))

data_orig <- inner_join(data_sehar, data_comp, by = "proj_isp") %>% 
	rename(typmen = typmen.y,
				 typmen_sehar = typmen.x)
	
# variables qui doivent être des facteurs : 
to_factor <- data_orig %>% 
	select( -fm_incluage, -BMI_INC, -year) %>% 
	map_lgl(is.numeric) %>%
		names
	
	
df <- data_orig %>% 	
	mutate_at(to_factor, as_factor) %>% 
	mutate_if(is.factor, fct_drop) %>% 

# recodages 
	mutate(cho17 = case_when(emploi ==2  ~ 1,
													 emploi == 1 ~ 0)) %>% 
	mutate(sante =fct_lump(EtatSante_INC,3, other_level = "4-8/8")) %>% 
	mutate(edu = case_when(edu == 0 ~ "<Bac",
												 edu == 1 ~ "Bac",
												 edu == 2 ~ ">Bac")) %>% 
	mutate(edu = factor(edu, levels = c("<Bac", "Bac", ">Bac" ))) %>% 
	mutate(FinSit = case_when(FinSit == "1" ~ "Difficultés",
														FinSit == "2" ~ "Parfois difficultés",
														FinSit == "3" ~ "Pas de difficultés"))
```

# qui est traité : qui est devient chômeur

```{r}

# un simple tableau croisé ==< ma solution préférée. 
df %>% select( homme, aveccouple01, avecenf01, age_cl, edu, region, FinSit,
							 inde, prive,
							 sante, ALCAB_INC, Tabac_INC, H_FV_INC, H_POISS_INC, inc_year_marie, cho17) %>% 
	tbl_summary(by  = cho17 ,
							statistic = all_categorical() ~ "{p}%", 
							digits = all_categorical() ~ 1) %>%  add_p()

```

# une régression logistique 


```{r}

fit1 <-
	glm(formula = cho17 ~ homme + typmen + age10inc + edu + 
				region + FinSit , family = binomial(), data = df)
summary(fit1)

fit2 <-
	glm(formula = cho17 ~ homme + typmen + age10inc + edu + region+ FinSit + sante + ALCAB_INC + Tabac_INC , family = binomial(), data = df)

tbl_regression(fit1, exponentiate = T, show_single_row = c(homme) ) %>% 
	modify_table_header(
		column = ci,
		hide = TRUE)

stargazer(fit1, apply.coef = exp, t.auto=F, p.auto=F)

```

# examiner les déséquilibres avant appariement (package MatchIt) 
 **! cas complets uniquement.**

```{r}

dfcc <- df %>% 
	select(homme, aveccouple01, avecenf01, age_cl, edu, region, FinSit, 
											prive, inde,
											sante, ALCAB_INC, Tabac_INC, H_FV_INC, H_POISS_INC, cho17) %>% 
	drop_na()

m.out0 <- matchit(cho17 ~ homme + aveccouple01 + avecenf01 + age_cl + edu + region+ FinSit + sante + ALCAB_INC + Tabac_INC, data = dfcc,
									method = NULL, distance = "glm")

summary(m.out0)
plot(summary(m.out0))

```

 ==> l'output n'est pas plus clair que le bon vieux tableau croisé, et le grpaphe non plus.

# DES essais sur l'ALCOOL

## évolution des pratiques -----------

 effet relatif de la continuité dans la pratique et du chômage
 
```{r}
 
data_orig <- read_dta("Data-Sehar/Data/ALCOHOL.dta")

freq(data_orig$ALCAB_2017)
freq(data_orig$ALCAB_INC)

lprop(table(data_orig$ALCAB_2017,data_orig$ALCAB_INC))

fit <- glm(ALCAB_2017 ~ ALCAB_INC, data = data_orig, family = binomial)
#odds.ratio(fit)
fit1 <- glm(ALCAB_2017 ~ Treated, data = data_orig, family = binomial)
#odds.ratio(fit1)

fit2 <- glm(ALCAB_2017 ~ ALCAB_INC + Treated, data = data_orig, family = binomial)
odds.ratio(fit2)

```

## un graphique pour l'alcool -----
```{r , echo = F eval = F}
df <- data_orig %>% 
	select(ALCAB_INC, Treated, ALCAB_2017) %>% 
	mutate_all(as.factor)

df %>% 
	group_by(ALCAB_INC, Treated, ALCAB_2017) %>% 
	count %>% 
	ggplot() +
	geom_bar(aes(x = Treated , fill = ALCAB_INC , y = n),
					 stat = "identity",
					 position = "dodge"
	)

```
 ==> pas merveilleux
 
 ## graphique avec des données "long" --------
```{r}
dfl <-df %>%
	pivot_longer(c(ALCAB_INC, ALCAB_2017)	,
							 names_to = "Phase", values_to = "alc") %>% 
	mutate(Phase = fct_recode(Phase, "Inclusion" ="ALCAB_INC",
														 "2017" = "ALCAB_2017")) %>% 
	mutate(Phase = relevel(Phase, ref = "Inclusion" )) %>% 
	drop_na()


# graphique avec des lignes

dfl %>% mutate(Alcool = 100* as.numeric(as.character(alc))) %>% 
	ggplot() +
	geom_line(aes(x = Phase, y =  Alcool, group = Treated, color = Treated),
						stat = "summary", fun= "mean") +
						ylab("Abus d'alcool (%)")  

```

```{r , eval = F, echo = F}
# graphique en barres, moins intéressant

dfl %>% group_by(Phase, Treated) %>%
	mutate(alc = as.numeric(as.character(alc))) %>% 
	summarise(alc_m = mean(alc)) %>% 
	ggplot() +
	geom_bar(aes(x = Phase, y =  alc_m, fill = Treated),
					 stat = "identity",
					 position = "dodge")
```


## examiner les données appariées par Sehar-----
```{r warning=F}

alcm_orig <- read_dta("Data-Sehar/Data/match_alc.dta")

# variables qui doivent être des facteurs : 
to_factor <- alcm_orig  %>% 
	select( -fm_incluage, -BMI_INC, -year, -cem_weights) %>% 
	map_lgl(is.numeric) %>%
	names


df <- alcm_orig  %>% 	
	mutate_at(to_factor, as_factor) %>% 
	mutate_if(is.factor, fct_drop)


fit <- glm(ALCAB_2017 ~ ALCAB_INC, data = df, family = binomial)
odds.ratio(fit)
fit1 <- glm(ALCAB_2017 ~ Treated, data = df, family = binomial)
odds.ratio(fit1)

fit2 <- glm(ALCAB_2017 ~ ALCAB_INC + Treated, data = df, family = binomial)
odds.ratio(fit2)

fit3 <-  glm(ALCAB_2017 ~ ALCAB_INC + Treated  , data = df, weights = cem_weights, family = binomial)
odds.ratio(fit3)

fit4 <-glm(ALCAB_2017 ~ ALCAB_INC + Treated + 
					 	L_POISS_INC + Tabac_INC + L_FV_INC + BMICat_INC + EtatSante_R_INC + chomagepast + cspvol + typmen + edu + fm_sexe + region  + FinSit + age10inc + INCDATEn 
					 , data = df, weights = cem_weights, family = binomial)
or4 <- odds.ratio(fit4)
```

## le beau talbeau ------

avec le package `modelsummary`, qui peut ensuite être retravaillé avec les autres packages à tableau.
Je n'affiche que les 2 coeffs intéressants : l'effet du traitement, et l'effet bien plus fort de la pratique antérieure.

```{r , warning = F}

modelsummary(fit4,  statistic = "p.value", statistic_vertical = FALSE, stars = T, exponentiate = T, coef_omit = "[^ALCAB_INC1|Treated1]",  gof_omit=".*")

tab <- modelsummary(list(fit2, fit3,fit4), 
						 statistic = "p.value", stars = T,
						 statistic_vertical = FALSE,  
						 exponentiate = T, 
						 coef_omit = "[^ALCAB_INC1|Treated1]",
						 gof_omit=".*",
						  notes = c("Données appariées",
						  					tag),
						 title = "Surconso alccol en 2017: effet du chômage et de la conso à l'inclusion OR et p-value",
						 output = "gt") 

tab %>%  cols_label(
    "Model 1" = "Non apparié",
    "Model 2" = "Apparié",
    "Model 3" = "Apparié ajusté"
  ) 


modelplot(list(fit2, fit3,fit4), coef_omit = "[^ALCAB_INC1|Treated1]")
```

 coef_omit : séparer par une barre les coefs à afficher. ne pas oublier le N° de la modalité de référence. 

on peut donner une liste de modèles.


 l'option , exponentiate = TRUE existe mais elle calcule les IC en prenant simplement l'exponentielle, ce qui n'est pas correct.  les p sont donc pê faux pour les Odds-ratio. en même temps je trouve que Sehar sous Stata et qu'avec la fonction odds.ratio() du package questionr...

 ==> je retrouve les résultats de Sehar.

liste des fichiers à fusionner
-	 merger tous les fichiers
-	 merger aussi les qq variables de HDR6-01 : typmen, public, inde
-	 faire une belle série de graphes
-	 et une belle série d'odds-ratio
	
- ALCOHOL
- FV
- FISH
- SANTE
- TOBACCO
- FRETOBdta
- BMI

```{r}

```


